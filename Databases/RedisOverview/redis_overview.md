# Redis 简介

Redis 是一个使用 ANSI C编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。Redis 是目前最流行的键值对存储数据库。

# Redis 优势

- 支持的数据类型丰富
    - String
    - List
    - Hash
    - Set
    - ZSet
    - ...
- 极其快速（10w+ QPS）
    - 基于内存
    - 数据结构简单（键值对），实现高效
    - 单进程单线程
    - I/O 多路复用，非阻塞 I/O
    - 使用 React 响应式设计模式监听 I/O 事件

# Redis 常用数据类型

## String 字符串

最基本的数据类型，二进制安全，底层`sds`。

## Hash 哈希表

字符串 -> 字符串 哈希字典表。

## List 列表

简单字符串列表。按字符串元素的插入顺序排序，可从两端插入元素，可存储元素上限：32 位无符号整数最大上限。

## Set 集合

字符串元素构成的无序不重复集合。底层实现为哈希表，插入、查询、删除的时间复杂度均为`O(1)`，支持交集、并集、差集等操作。

## Sorted Set 有序集合

字符串元素构成的有序不重复集合。每个元素关联一个`double`类型的分数，根据分数对元素进行排序（从小到大）。

# Redis 数据类型底层实现

- 简单动态字符串
- 双向链表
- 哈希字典
- 跳跃表
- 整数集合
- 压缩列表
- 对象

# Keys 查询指令的隐患

Redis `KEYS pattern`指令用于查找所有符合给定模式的 key ，返回符合给定模式的 key 列表。

Keys 查询指令的隐患：

- 一次性返回所有匹配的 key 。

- 单线程阻塞。

- keys 数量过多会造成 CPU、内存开销巨大，影响 Redis 服务。

解决方案：使用游标增量式迭代

`SCAN cursor MATCH pattern COUNT count` 初始游标为`0`，结束游标为`0`。迭代未结束时，以返回的游标作为下一次迭代的起始游标。注意，`SCAN` 有可能返回重复元素，需要依赖外部去重。

# Redis 分布式锁

分布式锁解决的问题：

- 互斥性
- 安全性
- 死锁

加锁指令（Redis 2.8 版本）：`SET key value [EX seconds | PX milliseconds] [NX | XX] [KEEPTTL]`

解锁指令：使用 Lua 脚本保证事务原子性。

```lua
if redis.call('get', KEYS[1]) == ARGV[1]
then
    return redis.call('del', KEYS[1])
else
    return 0
end
```

Redis 集群部署情况下，Redis 主从节点数据同步是异步的，如果 Redis 的 Master 节点在锁未同步到 Slave 节点的时候宕机，就会出现如下情况。

1. 进程 A 在 master 节点获得了锁。
2. 在锁同步到 slave 之前，master 宕机，数据还没有同步到 slave 。
3. slave 变成了新的 master 节点。
4. 进程 B 也得到了和进程 A 相同的锁。

在这种情况下，Redis 官方为我们提供了另一种解决方案：RedLock 红锁算法。

...

# Redis 持久化

## RDB 快照全量持久化

保存 Redis 某个时间点的全量数据快照。

- `SAVE`指令：阻塞 Redis 服务进程，直至 RDB 快照文件创建完毕。

- `BGSAVE`指令：Fork 出一个子进程创建 RDB 快照文件，不阻塞 Redis 服务进程。

缺点：

- 内存数据的全量备份，数据量过大时会因为内存磁盘 I/O 严重影响性能。

- 会因为 Redis 服务挂掉而丢失从当前时间至最近快照同步期间的增量数据。

## AOF（Append-Only-File） 增量日志持久化

记录下除查询指令外所有变更 Redis 数据状态的指令，以指令日志的形式增量追加到 AOF 日志文件中。

## RDB 与 AOF 对比

| 备份方式 | 优点  | 缺点  |
| :------ | :--- | :---- |
| RDB    | 全量数据快照备份，文件体积小，恢复速度快。 | 无法保存最近一次快照至当前时间点的增量数据。 |
| AOF    | 文件可读，增量保存指令，数据不易丢失。 | 文件体积大，恢复时间长。 |

> 表：RDB 与 AOF 对比表

RDB-AOF 混合持久化方式结合了 RDB 与 AOF 的优势，是目前较为推荐的 Redis 持久化方式。

## Redis 数据恢复






<!-- EOF -->